<!DOCTYPE html>
<html>
<head>
<title>Formular</title>
</head>
<style>
    .container {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .eingabefelderContainer {
        margin-left: 850px;
    }
    .tickets {
        overflow-y: auto;
        overflow-x: hidden;
        font-size: small;
        border-style: solid;
        width: 200px;
        height: 350px;
    }
    button {
        margin-top: 0.5rem;
    }
    body {
        background-image: url("windows-98-background-mvrmy77vuyblzxba.jpg");
    }
    #kommentarFeld {
        max-width: 172px;
        max-height: 100px;
        min-width: 172px;
        min-height: 100px;
    }
</style>
<body>
<img src="Pflanzen-Koelle-Logo-gruen.jpg" alt="Pflanzen-Koelle Logo" style="width:300px;height:180px; margin-left: auto; margin-top: auto;">
<h1 id="formularHeader" style= "max-width: fit-content; margin-left: auto; margin-right: auto;">Kontaktieren Sie uns</h1>
<div class="container">
    <div class="eingabefelderContainer">
        <label for="textVorname"><b>Vorname:</b></label>
        <br>
        <input type="text" id="textVorname" name="textVorname"><br><br>
        <label for="textNachname"><b>Nachname:</b></label>
        <br>
        <input type="text" id="textNachname" name="textNachname"><br><br>
        <label for="textEmail"><b>Email:</b></label>
        <br>
        <input type="text" id="textEmail" name="textEmail"><br><br>
        <label for="datePickerGeburtstag"><b>Geburtstag:</b></label>
        <br>
        <input type="date" id="datePickerGeburtstag"/><br><br>
        <label for="kommentarFeld"><b>Kommentar eingeben:</b></label>
        <br>
        <textarea id="kommentarFeld"></textarea>
        <br>
        <button onclick="saveUser()">Absenden</button>
        <p id="fehler" style="color: rgb(255, 0, 0);"></p>
    </div>
        <div class="ticketContainer" id="ticketContainer">
        <h3>Eingegangene Formulare:</h3>
        <div class="tickets" id="tickets"> 
        </div>
    </div>
</div>

<script>
    class Person {
        constructor(vorname, nachname, email, geburtstag, kommentar) {
        this.vorname = vorname;
        this.nachname = nachname;
        this.email = email
        this.geburtstag = geburtstag
        this.kommentar = kommentar
        }
    }

    const dateNow = new Date()
    
    function saveUser() {
        try {
            const vornameInput = document.getElementById("textVorname").value;
            const nachnameInput = document.getElementById("textNachname").value;
            const kommentarInput = document.getElementById("kommentarFeld").value;
            const emailInput = document.getElementById("textEmail").value;
            const geburtstagInputInDate = new Date(document.getElementById("datePickerGeburtstag").value);
            const geburtstagJahr = document.getElementById("datePickerGeburtstag").value

            let emailString = emailInput.toString();

            checkInputs(vornameInput, nachnameInput, kommentarInput, emailInput, geburtstagJahr, geburtstagInputInDate)

            person = new Person(vornameInput, nachnameInput, emailInput, geburtstagJahr, kommentarInput)
            console.log(person)
            sendTicket(person)
            requestTickets()
            alert("Erfolgreich abgeschickt")
        } catch (error) {
            console.error("Etwas ist schief gelaufen", error)
            alert("Ein Feher ist aufgetaucht")
        }
    }

    function checkInputs(vornameInput, nachnameInput, kommentarInput, emailInput, geburtstagJahr, geburtstagInputInDate) {
        document.getElementById("fehler").innerText = ""

        if (vornameInput == "" || nachnameInput == "" || geburtstagJahr == "" || kommentarInput == "" || emailInput == "") {
                document.getElementById("fehler").innerText = "Bitte alle Felder ausfüllen"
                throw new Error("Fehlende Angaben")
        }
        if (!vornameInput.match(/^[a-zäöüßA-ZÄÖÜß]+$/)) {
                document.getElementById("fehler").innerText = "Ungültiger Vorname"
                throw new Error("Ungültige Zeichen im Vornamen")             
        }
        if (!nachnameInput.match(/^[a-zäöüßA-ZÄÖÜß]+$/)) {
                document.getElementById("fehler").innerText = "Ungültiger Nachname"
                throw new Error("Ungültige Zeichen im Nachnamen")             
        }

        if (!emailInput.match(/^[a-zäöüßA-ZÄÖÜß0-9@._-]+$/)) {
            document.getElementById("fehler").innerText = "Ungültige Email"
            throw new Error("Email Invalid")
        } else {
            const emailArray = emailInput.split("");
            let positionEtt = -1
            let positionDot = -1

            for (let index = 0; index < emailArray.length; index++) {
                const element = emailArray[index];
                if (element === "@") {
                    positionEtt = index
                }
                if (element === ".") {
                    positionDot = index
                }
            }

            if (positionEtt == -1 || positionDot == -1 || Math.abs(positionEtt - positionDot) <= 5) {
                document.getElementById("fehler").innerText = "Ungültige Email"
                throw new Error("Email Invalid")
            }
        }

        if (!emailInput.includes("@") || !emailInput.includes(".")) {
                document.getElementById("fehler").innerText = "Ungültige Email"
                throw new Error("Email Invalid")
            }
        if (geburtstagInputInDate >= dateNow) {
                document.getElementById("fehler").innerText = "Geburtstag invalid"
                throw new Error("Invalid Geburtstag")
        }
    }
    
    async function sendTicket(person) {
        const response = await fetch("/api/postTicket/", {
            method: "POST",
            body: JSON.stringify({
                person
            }),
            headers: { "Content-Type": "application/json" },
        })
        .then((response) => response.json())
        .then((json) => console.log(json));
    }

    async function requestTickets() {
        const response = await fetch("/api/getTickets");
        const data = await response.json();
        console.log(data);

        const tickets = data.tickets
        console.log(tickets);

        const ticketContainer = document.getElementById("tickets")
        ticketContainer.innerHTML = ""

        tickets.forEach(ticket => {
            const id = ticket.id
            const person = ticket.newPerson
            ticketContainer.innerHTML += `
            <div class="ticketss">
                <p style="color: red;"><b>${id}:</b></p>
                <label><b>Vorname: </b>${person.vorname}</label>
                <br>
                <label><b>Nachname: </b>${person.nachname}</label>
                <br>
                <label><b>Email: </b>${person.email}</label>
                <br>
                <label><b>Geburtstag: </b>${person.geburtstag}</label>
                <br>
                <label><b>Kommentar: </b>${person.kommentar}</label>
            </div>`
        });
    }

</script>

</body>
</html>